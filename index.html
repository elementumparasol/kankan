<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Hello World!</title>
    <!-- https://electronjs.org/docs/tutorial/security#csp-meta-tag -->
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <link rel="stylesheet" type="text/css" href="static/css/light.css" id="theme-css" />
    <style>
        body,
        html {
            height: 100%;
            padding: 0;
            margin: 0;
            overflow-y: hidden;
            background: var(--bg-color);
        }

        a {
            text-decoration: none;
            color: white;
        }

        .title-bar {
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            text-align: center;
            /* background-color: var(--title-bg-color); */
            background-image: var(--title-bg-img);
            /* background-image: linear-gradient(red, yellow, blue); */
            height: var(--title-bar-h);
            -webkit-app-region: drag;
            overflow-x: hidden;
            border-bottom: var(--title-border);
            padding-top: var(--tool-padding);
            padding-left: 80px;
            user-select: none;
            /* padding-right: var(--tool-padding); */
        }

        button {
            height: calc(var(--title-bar-h) - var(--tool-padding));
            border-radius: 5px;
            /* background: var(--btn-tool-bg); */
            background-image: var(--btn-tool-img);
            color: var(--btn-tool-color);
            outline: none;
            border: var(--btn-tool-border);
            margin-right: -4px;
            padding-top: 2px;
            /* margin-right: var(--tool-padding); */
        }

        button:hover {
            /* background: #f1f1f1; */
            /* cursor: pointer !important; */
            background: var(--btn-tool-bg-hover);
        }

        button:active {
            background: var(--btn-tool-bg-active);
        }

        button:disabled {
            background-image: var(--btn-tool-img-disabled);
            color: var(--btn-tool-color-disabled);
        }

        .title {
            /* -webkit-app-region: drag; */
            position: fixed;
            left: 280px;
            right: 280px;
            top: 0;
            /* padding-top: 9px; */
            height: calc(var(--title-bar-h) + var(--tool-padding));
            line-height: calc(var(--title-bar-h) + var(--tool-padding));
            user-select: none;
            font-size: var(--title-font-size);
            overflow-x: hidden;
            color: var(--title-color);
            display: inline-block;
        }

        .main {
            margin-top: var(--title-bar-h);
            height: calc(100% - var(--title-bar-h));
            overflow: hidden;
            /* padding:10px 0px; */
        }

        .container {
            /* background: #333; */
            height: 100%;
        }

        .img {
            /* border: 1px solid #111; */
            position: absolute;
            /* cursor: url('move.ico'),auto; */
            max-height: calc(100% - var(--title-bar-h));
            max-width: 100%;
            width: auto;
            height: auto;
            padding-top: calc(var(--title-bar-h));
            user-select: none;
            /* height: 100%;
            width: auto; */
        }

        .btn-to {
            cursor: pointer;
            position: fixed;
            top: 0;
            height: 100%;
            color: var(--btn-to-color);
            padding: 0 20px;
            background: var(--btn-to-bg);
            /* visibility: hidden; */
            opacity: 0;
        }

        .btn-to:hover {
            opacity: 1;
        }

        .btn-txt {
            user-select: none;
            position: relative;
            top: calc(50% - var(--tool-padding)/2);
            /* transform: translateY( -50% ); */
        }

        .open-file {
            position: fixed;
            top: calc(50% - 30px);
            width: 100%;
            text-align: center;
            display: none;
        }

        .open-file h2 {
            color: var(--open-h2-color);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="main" id="div" onmousewheel="return bbimg(this)">
            <img class="img" id="img" ondblclick="initParams()" onload="resize()">
        </div>
        <div class="open-file" id="open-file">
            <h2>Kan Kan</h2>
            <button onclick="openFileWin()">打开图片</button>
        </div>
        <div style="right: 0;" class="btn-to" onclick="next()">
            <div class="btn-txt">下一张</div>
        </div>
        <div style="left: 0;" class="btn-to" onclick="previous()">
            <div class="btn-txt">上一张</div>
        </div>
        <div class="title-bar">
            <!-- ondblclick="maxWindow()" -->
            <div id="title" class="title" ondblclick="maxWindow()">
            </div>
            <div style="float: left;">
                <button onclick="previous()"> 上一张 </button>
                <button onclick="next()"> 下一张 </button>
            </div>
            <div style="display: block;float: right;padding-right: 95px;">
                <button onclick="setWallpaper()" id="btn-wallpaper">设为壁纸</button>
                <button onclick="copyFile()">拷贝</button>
                <!-- <button onclick="showMenu()">菜单</button> -->
                <button onclick="changeDefaultTheme()" id="btn-theme">暗</button>
            </div>
        </div>
    </div>

    <script src="img.js"></script>

    <script language="javascript">
        var remote = require('electron').remote;
        var index = remote.getCurrentWindow().id - 1;
        var data = { imgs: [], current: 0 };
        var max = false;

        function setGlobalData() {
            data = remote.getGlobal('data')[index];
        }

        function maxWindow() {
            if (!max) {
                remote.getCurrentWindow().maximize();
            } else {
                remote.getCurrentWindow().unmaximize();
            }
            max = !max;
            initParams()
        }

        function setCurrentImg() {
            setImg(data.current)
        }

        function setImg(id) {
            //没有输入
            if (isImgNull()) {
                showOpenFile(true)
                return
            }
            //有输入
            initParams();
            if (id < 0 || id >= data.imgs.length) {
                id = 0
            }
            // // 删除之前的img
            // if (div.firstChild) {
            //     div.removeChild(div.firstChild)
            // }
            // 重绘新img
            setImgSrc(data.imgs[id])
            // set title
            setTitle(getFileName(data.imgs[id]))
            //log
            console.log("set img:", data.imgs[id])
        }

        function setImgSrc(src) {
            img = document.getElementById('img')
            img.style.visibility = 'hidden'
            img.src = src
        }

        // function getImgHtml(src) {
        //     return '<img class="img" id="img" ondblclick="initParams()" onload="resize()" src="' + src + '" style="visibility:hidden"/>'
        // }

        function setTitle(title) {
            document.getElementById("title").innerText = title
        }

        function next() {
            if (isImgNull()) {
                return false
            }
            data.current += 1
            if (data.current == data.imgs.length) {
                data.current = 0;
            }
            setImg(data.current)
        }

        function previous() {
            if (isImgNull()) {
                return false
            }
            data.current -= 1
            if (data.current < 0) {
                data.current = data.imgs.length - 1;
            }
            setImg(data.current)
        }

        function getCurrentImg() {
            if (isImgNull()) {
                return ""
            }
            return data.imgs[data.current]
        }

        function getFileName(file) {
            if (file == "") {
                return ""
            }
            var obj = file.lastIndexOf("/");
            return file.substr(obj + 1);//文件名
        }

        var params = {
            zoomVal: 1,
            left: 0,
            top: 0,
            currentX: 0,
            currentY: 0,
            flag: false
        };

        function esc() {
            remote.getCurrentWindow().close()
        }

        // 监听键盘事件
        document.onkeydown = function (event) {
            event = event || window.event;/*||为或语句，当IE不能识别event时候，就执行window.event 赋值*/
            // console.log(event.keyCode);
            switch (event.keyCode) {/*keyCode:字母和数字键的键码值*/
                case 27:
                    //esc
                    esc()
                    break;
                /*37、38、39、40分别对应左上右下*/
                case 37:
                case 38:
                    previous()
                    break;
                case 39:
                case 40:
                    next()
                    break;
            }
        }

        const themeDark = false
        const lightDark = true
        var defaultTheme = themeDark

        function changeDefaultTheme() {
            changeTheme(!defaultTheme)
            defaultTheme = !defaultTheme
        }

        function changeTheme(isDark) {
            theme = document.getElementById('theme-css')
            btnTheme = document.getElementById('btn-theme')
            if (isDark) {
                theme.href = 'static/css/dark.css'
                btnTheme.innerText = '亮'
            }
            else {
                theme.href = 'static/css/light.css'
                btnTheme.innerText = '暗'
            }
        }

        function resize() {
            var img = document.getElementById('img');
            initParams()
            // var size =remote.getCurrentWindow().getSize()
            // if(img.offsetHeight<size[1]){
            //     remote.getCurrentWindow().setSize(size[0],img.offsetHeight)
            // }
            // if(img.offsetHeight<size[0]){
            //     remote.getCurrentWindow().setSize(img.offsetWidth,size[1])
            // }
            img.style.visibility = "visible"
        }
        //on window resize
        window.onresize = function () {
            initParams()
        };

        function isImgNull() {
            return data.imgs.length < 1
        }

        function showOpenFile(isShow) {
            console.log('show open file:', isShow)
            openFile = document.getElementById('open-file')
            if (isShow) {
                openFile.style.display = 'inherit'
            } else {
                openFile.style.display = 'none'
            }
        }

        window.onload = () => {
            //读取数据
            setGlobalData()
            //判断数据是否为空
            if (isImgNull()) {
                showOpenFile(true)
                return false
            }
            // 绘制图片
            setImg(data.current);
            // 监听拖拽、放大
            startDrag(document.getElementById("img"), document.getElementById("img"))
        }

    </script>
    <script>
        const { ipcRenderer } = require('electron')

        function openFileWin() {
            ipcRenderer.send('openImg','')
        }

        ipcRenderer.on('openImg-cb', (event, msg) => {
            console.log("open", msg)
            if (msg == 'ok') {
                setGlobalData()
                setCurrentImg()
                showOpenFile(false)
            }
        })

        ipcRenderer.on('themeChanged', (event, msg) => {
            console.log("themeChanged: isDark", msg)
            changeTheme(msg)
        })

    </script>
    <script language="javascript">
        const { Menu, MenuItem } = remote
        const { clipboard } = require('electron') //剪切板
        const nativeImage = require('electron').nativeImage
        const exec = require('child_process').exec

        function setWallpaper() {
            if (isImgNull()) {
                alert("没有打开任何图片")
                return false
            }
            document.getElementById('btn-wallpaper').disabled = true
            var imgPath = getCurrentImg()
            console.log('set wallpaper:', imgPath)
            workerProcess = exec("osascript -e 'tell application \"Finder\" to set desktop picture to POSIX file \"" + imgPath + "\"'")
            // 打印日志
            workerProcess.on('exit', (data) => {
                console.log('exit: ' + data);
                if (data == '0') {
                    alert('设置壁纸成功!')
                } else {
                    alert('设置壁纸失败!\n - 请检查图片路径或者访问权限')
                }
                document.getElementById('btn-wallpaper').disabled = false
            })
            // 打印错误的后台可执行程序输出
            workerProcess.stderr.on('data', function (data) {
                console.log('stderr: ' + data);
            });
        }

        function copyFileName() {
            if (isImgNull) {
                alert("没有打开任何图片")
                return false
            }
            clipboard.writeText(getFileName(getCurrentImg()))
        }

        function copyFilePath() {
            if (isImgNull) {
                alert("没有打开任何图片")
                return false
            }
            clipboard.writeText(getCurrentImg())
        }

        function copyFile() {
            if (isImgNull) {
                alert("没有打开任何图片")
                return false
            }
            const image = nativeImage.createFromPath(getCurrentImg())
            clipboard.writeImage(image)
        }

        const menu = new Menu()
        menu.append(new MenuItem({
            label: '复制文件名', click() {
                copyFilename()
            }
        }))
        menu.append(new MenuItem({
            label: '复制路径', click() {
                copyFilePath()
            }
        }))
        menu.append(new MenuItem({ type: 'separator' }))
        menu.append(new MenuItem({
            label: '拷贝', click() {
                copyFile()
            }
        }))
        menu.append(new MenuItem({ type: 'separator' }))
        menu.append(new MenuItem({
            label: '设为壁纸', click() {
                setWallpaper()
            }
        }))
        menu.append(new MenuItem({ type: 'separator' }))
        menu.append(new MenuItem({ label: '原始大小', click() { initParams() } }))
        menu.append(new MenuItem({ type: 'separator' }))
        menu.append(new MenuItem({ label: '上一张', click() { previous() } }))
        menu.append(new MenuItem({ label: '下一张', click() { next() } }))
        // menu.append(new MenuItem({ type: 'separator' }))
        // menu.append(new MenuItem({ label: '复制', type: 'checkbox', checked: true }))
        menu.on('menu-will-close', (e) => {
            menuLock = false;
        })

        window.addEventListener('contextmenu', (e) => {
            showMenu()
            e.preventDefault()
        }, false)

        function showMenu() {
            menuLock = true;
            menu.popup({ window: remote.getCurrentWindow() })
        }

    </script>
</body>

</html>